<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OAuth Callback - WolfCal</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        background: #f5f5f5;
      }
      .container {
        text-align: center;
        background: white;
        padding: 40px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        max-width: 400px;
      }
      h2 { margin-top: 0; }
      .error { color: #d32f2f; }
      .success { color: #2e7d32; }
      .info { color: #666; font-size: 14px; }
    </style>
  </head>
  <body>
    <div class="container">
      <h2 id="title">Processing OAuth...</h2>
      <p id="message">Exchanging authorization code for tokens...</p>
    </div>
    <script type="module">
      // This script is copied from the OAuthCallback component logic
      // but runs standalone in the callback.html page
      
      const titleEl = document.getElementById('title');
      const messageEl = document.getElementById('message');
      
      async function handleCallback() {
        try {
          // Parse URL parameters
          const params = new URLSearchParams(window.location.search);
          const code = params.get('code');
          const error = params.get('error');
          
          // Check for errors from Google
          if (error) {
            throw new Error(
              error === 'access_denied'
                ? 'OAuth access was denied by the user'
                : `OAuth error: ${error}`
            );
          }
          
          // Validate required parameters
          if (!code) {
            throw new Error('Authorization code not found in callback URL');
          }
          
          // Get the base path
          const basePath = '/wolfcal';
          
          // Retrieve client credentials from localStorage
          const clientId = localStorage.getItem('wolfcal:oauth:clientId');
          const clientSecret = localStorage.getItem('wolfcal:oauth:clientSecret');
          
          if (!clientSecret || !clientId) {
            throw new Error('Client credentials not found. Please return to WolfCal and configure OAuth credentials first.');
          }
          
          // Exchange authorization code for tokens
          const tokenResponse = await fetch('https://oauth2.googleapis.com/token', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
              code,
              client_id: clientId,
              client_secret: clientSecret,
              redirect_uri: window.location.origin + basePath + '/callback',
              grant_type: 'authorization_code',
            }),
          });
          
          if (!tokenResponse.ok) {
            const errorData = await tokenResponse.json();
            throw new Error(errorData.error_description || errorData.error || 'Token exchange failed');
          }
          
          const tokens = await tokenResponse.json();
          
          // Send tokens to parent window via postMessage
          const message = {
            type: 'oauth-success',
            tokens,
          };
          
          if (window.opener) {
            window.opener.postMessage(message, window.location.origin);
          }
          
          // Show success message
          titleEl.textContent = 'Success!';
          titleEl.className = 'success';
          messageEl.innerHTML = 'Authentication complete. You can close this window.';
          
          // Close window after a delay
          setTimeout(() => {
            window.close();
          }, 2000);
          
        } catch (err) {
          const errorMessage = err instanceof Error ? err.message : 'Unknown error occurred';
          
          // Show error message
          titleEl.textContent = 'Authentication Failed';
          titleEl.className = 'error';
          messageEl.innerHTML = `<p style="color: #d32f2f;">${errorMessage}</p>`;
          
          // Send error to parent window
          const message = {
            type: 'oauth-error',
            error: 'OAuth Failed',
            description: errorMessage,
          };
          
          if (window.opener) {
            window.opener.postMessage(message, window.location.origin);
          }
        }
      }
      
      // Handle the callback
      handleCallback();
    </script>
  </body>
</html>
