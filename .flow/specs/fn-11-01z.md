# Fix QR Code Export Size Limit

## Overview

QR code export fails for users with multiple accounts/calendars because encrypted payload (4408 bytes) exceeds QR capacity (2953 bytes for version 40-L).

**Root cause:** Double base64 encoding in `transferCrypto.ts` adds ~84% overhead:
1. Salt, IV, ciphertext each base64 encoded separately
2. JSON wrapper containing those strings is base64 encoded again

**Solution:** Binary concatenation format + gzip compression:
- Concat raw bytes: `version (1) || salt (16) || iv (12) || compressed_ciphertext`
- Single base64 at end
- Expected reduction: 4408 â†’ ~1500-1800 bytes

## Scope

**In scope:**
- Refactor `encrypt()` to use binary format with compression
- Update `decrypt()` to handle both old and new formats (backward compatible)
- Add format version marker for future-proofing
- Update tests

**Out of scope:**
- Multi-QR code splitting (future enhancement if still needed)
- QR error correction level configuration
- Calendar name truncation

## Quick commands

```bash
# Run tests
npm test

# Build and check for errors
npm run build

# Manual test: export config, check console for size debug output
```

## Acceptance

- [ ] QR code generates successfully for configs up to 2953 bytes encrypted
- [ ] User with 2 accounts + 9 calendars can export via QR (the reported case)
- [ ] Old format URLs can still be imported (backward compatibility)
- [ ] New format uses ~50% less bytes than current implementation
- [ ] All existing tests pass
- [ ] New tests cover format versioning and compression

## References

- Root cause: `/home/deploy/src/wolfcal/src/lib/config/transferCrypto.ts:100-113`
- Size limit: `/home/deploy/src/wolfcal/src/components/ExportConfiguration.tsx:11`
- Existing tests: `/home/deploy/src/wolfcal/src/test/config/transferCrypto.test.ts`
- Prior work: fn-9-nas (encryption infrastructure), fn-10-xzj (token removal)
